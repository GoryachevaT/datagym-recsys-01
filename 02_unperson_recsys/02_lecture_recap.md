# 02 Unpersonalized Recommendations

## 1. General

### Неперс. рекомендации 
Что это? (пересекаются у разных пользователей, не учитывают профиль пользователя)
### Плюсы unpers recsys
- быстрый и предсказуемый результат (минимизируем риски проекта)
- возможность сразу протестировать аналитику на простой системе
- возможность протестировать нужность проекта
- возможность протестировать бизнес-процессs
- отличная возможность поэкспериментировать с метриками с заказчиком (и вообще пониманием задачи) [история про детект брака в сталепрокате]
- эксперименты с бейзлайном могут дать информацию о пользователях: 
  - а что вообще популярно
  - какие есть группы пользователей
  - нужно ли разнообразить рекомендации
  - как быстро обновляется топ (а нужно ли часто переобучать модель)
  - как часто рекомендации должны сменяться
- запустит процесс разработки на беке и клиентах и потом нам достаточно будет просто менять алгоритм

### Особенности сервиса:
- все пользователи холодные или профиль кардинально меняется (авито, airbnb, booking, skyscanner)
- это лендинг

### Examples
- "Похожие" на airbnb: https://www.airbnb.com/rooms/20532496?location=Saint%20Petersburg%2C%20Russia&adults=2&children=1&check_in=2020-04-05&check_out=2020-04-11&source_impression_id=p3_1585684530_eJF42G9mfdcvN8Q4
- Skyscanner говорит что топы популярных - это персональные рекомендации: https://www.skyscanner.ru/?previousCultureSource=GEO_LOCATION&redirectedFrom=www.skyscanner.net
- Лендинг букмейт https://bookmate.com и там же в библиотеке подборки по разным смыслам

### Уравновешивание рекомендаций:
- exploration (интерпретируемость)
- размыкание learning loop (мы обучаемся на том, что рекомендуем и это проблема)
- преимущества перед персональными подборками:
    - их проще объяснить -> пользователь больше доверяет
    - их проще разнообразить и пользователь сможет сам выбрать где искать айтемы
    - можно гораздо круче оформить, снабдить текстом, картинками (ламповые редакторские подборки и тд)
    - можно подобрать под праздник / событие
        - Офигенное оформление внутри подборки https://daily.bandcamp.com/best-hip-hop/the-best-hip-hop-on-bandcamp-march-2020
        - Пример тематической подборки в майбук https://mybook.ru/sets/9574-v-dikih-usloviyah-knigi-o-bezdomnyh-i-sirotah/

### А также в случаях:
- новый сервис
    - must новый сервис для поиска кино: https://mustapp.com
    - поиск кино по эмоджи https://emovi.app
- замена отсутствующего товара
- апсел аксессуаров и мелких товаров
    - аксессуары в м-видео будут преследовать до конца оформления заказа: https://www.mvideo.ru/products/noutbuk-apple-macbook-air-13-i5-1-8-8gb-128ssd-mqd32ru-a-30028577
- автоматическая каталогизация новых товаров
    - авито: часто проще что-то найти по поиску и потом ходить по похожим https://www.avito.ru/moskva?q=надувной+ангар
- хочется использовать контекст в котором пользователь ищет айтемы

## 2. Сортировки

### Какими бывают
- по новизне (треш в топе => нужна фильтрация; фильтровать новое - сложно, тк нет статистики, можно использовать бренд / артиста / источник информации)
- по цене / размеру скидки (если очень большой раздел, то видно либо самое дешевое, либо самое дорогое, а обычно нужно что-то среднее)
- популярности (что такое популярность? клики? просмотры? покупки?) проблемы: кликбейт (рекомендуем самое кликабельное, но вообще не покупабельное), статичный топ, невозможно найти что-то нужное
Пример с кворой как собирать клики: https://www.quora.com/topic/Recommender-Systems-1 
 - по рейтингу / оценке (проблема: если решать в лоб, то в топе айтемы с 2 оценками, если сразу получить низкую оценку, то подняться не получится)

### Сортировка по рейтингу. Формула старого Кинопоиска:
R = ( A / (A+m) )M + ( m / (A+m) )C

- R - рейтинг фильма,
- A - количество голосов,
- m - минимальный порог,
- M - среднее арифметическое всех голосов за фильм,
- C - среднее значение рейтинга всех фильмов.
- ^ подтапливает айтемы с малым числом оценок и высоким рейтингом , приподнимает с малым рейтингом

- примеры сортировок в майбуке: https://mybook.ru/catalog/knigi-po-psihologii/books/
- примеры сортировок на маркете: https://market.yandex.ru/catalog--shurupoverty/56413/list?hid=91650&track=pieces&local-offers-first=0&onstock=1
- пример стандартных топ 100 (по сути обрезанная сортировка) - (кинопоиск): https://www.kinopoisk.ru/top/

### Улучшаем сортировки / топы:
- Разбиваем пользователей на группы и строим рейтинги для групп:
    - используем соцдем
    - локация пользователей
    - новый пользователь / старый
    - всякие тиггеры (посмотрел фильма жанра детектив, купил заграничные/локальный билет)
- обнуляем топы при смене сезона (например магазин одежды)
- trending (кол-во просмотров за последние несколько дней, угасающие со временем скоры)
    - trending в twitter: https://twitter.com/i/trends
- спросить у пользовтаеля категорию он любит https://infomate.club

Разбиение на группы товаров может быть как жестким (пользователь в этом сегменте => у него такое ранжировнаие), так и мягким (оцениваем близость к каждому сегменту, замешиваем с весами)

## 3. Похожие товары

**Примеры:**
    - авито похожие товары: https://www.avito.ru/taganrog/audio_i_video/pribor_dlya_nastroyki_televizora_h1-7a_pnt-59_118110
    - майбук похожие книги https://mybook.ru/author/uilyam-berrouz/dikie-malchiki-2/
    - https://hh.ru/vacancy/36324804?query=Data%20scientist

**Зачем:**
- товары заменители
- позволяет не упустить юзера
- заменяем пустой результат поиска
- можно догнать и вернуть брошеную корзину предложив заменители дешевле [пример: довоз в утконосе]
- апсейл
    - аксессуары, связанные товары
    - просто мелочевка
    - амазон предлагает товары которые вместе покупают и которые вместе смотрят: https://www.amazon.com/Recommender-Systems-Handbook-Francesco-Ricci-ebook/dp/B00D8D1Y10/ref=sr_1_1?crid=1VYX1VDZY6Y7T&dchild=1&keywords=recommender+systems+handbook&qid=1585729069&sprefix=recommender+systems+handbook%2Caps%2C-1&sr=8-1
- [додо пицца, сначала сделали POC и этим обосновали найм датасаентиста]

**Строим похожие товары**
- контент (описание/картинки/тех.характеристики) => NLP, обработка картинок итд
- one hot на тегах, ключевых словах, описании
- tf/idf на тегах, ключевых словах, навыках
- NLP на описании, заголовке [пример с GCP рекомендатором и данным, которые ему нужны]
- классический классификатор
- логические операции на категориальных признаках
- дельты числовых признаков
- агрегации по ^
- картинки
- звуковой ряд [shazam]
- вектора из факторизации матриц / эмбеддиги нейронок

**Как в авито ищут похожие айтемы**
- **Модель**
    - https://habr.com/ru/company/avito/blog/491942/
    - таргет:
        - запрос контакта
        - ограничение в 8 часов
        - негативные примеры случайные семплы (Причём выбираем вероятностно пропорционально квадратному корню из количества контактов, которое было совершенно на эти айтемы в месяц события контакта пары, которую мы достали из датасета.) т.е. пропорционально "удачности" объявления и возможно его месту в UI
    - модель обучалась сразу с учетов выбранного расстояния
    - что получили:
        - модель, которой не нужна история, все айтемы сразу попадают в нее
        - модель, которую не нужно переобучать
- **Ранжирование** 
    - sim(i, j) = <v_i, v_j> * (log(t_j + 1) ^ a_c), т.е.
    - похожесть перевзвешивается на новизну объявления  
    - для каждой категории скорость устаревания своя
    - учитывают регион, но предлагают делают отдельный рейтинг без учета региона с авито-доставкой
    - результаты: Переход на item2vec увеличил на 30% контакты с похожих, !! на 20% контакты с ленты персональных рекомендаций и значимо прирастил байеров на Авито. (Сейчас лента персональных рекомендаций — это смешение двух моделей, одна из которых берет похожие на те, что пользователь смотрел, и ранжирует их.)

## 4. Онбординг
[пример YouTube Music]
- Самостоятельный поиск контента пользователем без учета его профиля
- активный поиск
- возможность пользователю выйти из filter bubble

**Примеры:**
- https://movix.ai пример проблемы когда пользователь попал в "туннель": https://movix.ai/discover/m8059!,m9281!,m8466!
- пример интерактивный рекомендатор в mybook: https://mybook.ru/reco/?likedBooks=147132,372781

## 5. Суперконтекстные рекомендации
- захват предыдущего контекста
- рекомендации на последней страницы книги в mybook: работает очень круто (примерно в 2-2.5 раза меньше добавлений, чем из рекомендатора на главной)
    - в начале книг МИФ есть раздел "Эту книгу хорошо дополняют:": https://www.litres.ru/frederik-lalu/otkryvaya-organizacii-buduschego/
	- (Причем можно использовать как ML так и правила почти как похожие книги, но можно сделать лучше: учет серии, учет года выпуска)
    - пустой поиск в майбуке: https://mybook.ru/sets/9322-ot-mikroba-do-pandemii-knigi-o-virusah/
- Коррекция и саджесты в поиске на основе предыдущего просмотра
    - пример с RecSys, Amazon ранжирует саджесты на основе предыдущих запросов: Ghosting: Contextualized Inline Query Completion https://recsys.acm.org/recsys19/session-4/

## 6. Социальные рекомендации
- плейлисты / ридинг листы друзей
- не такие точные, но может сильнее привязывать людей к сервису
- более разнообразные
- стимулирует генерить UGC
- вызывает большее доверие
- объединяет пользователей
- примеры
    - https://www.goodreads.com
    - https://www.livelib.ru/selections
- может довольно круто зайти в еде, рекомендациях достопримечательностей, тк пользователю легко оценить насколько у него профиль совпадает с рекомендующим

## 7. Гиперлокальные рекомендации
 - яндекс район https://yandex.ru

## 8. Метрики

### Офлайн метрики
- MSE - плохо

### Онлайн метрики
- Давайте тогда просто построим топ товаров и будем показывать его всем
- а что такое топ товаров? Какой критерий топовости? Деньги / конверсия / spent time? Или эвристика какая-то?
- Представим, что сделали идеальное ранжирование: а как мы поймем, что стало хорошо?
- Тут разговор про онлайн метрики (традиционные: деньги, конверсии, возвращаемость). Какие есть, почему неидеальны, как можно абьюзить. Что метрики могут быть на разных уровнях (конверсии в просмотр, клик, корзину, покупку)
- Важно на уровне бизнеса определиться с метрикой
- Какие есть дефолтные частоисползуемые варианты метрик для старта
- Какие могут возникать перекосы (отпимизируем деньги - падает конверсия и тд)
- Возвращаеся к теме построения топа - строим его исхдя из нашей бизнесовой метрики. (и примеры под разные таргеты)
- Важно думать не только про метрики точности, но и про метрики разнообразия, они противоречат друг другу

## 9. Мы сделали идеальную неперсонализированную сортировку. Что дальше?
Неперсонализированная подборка - хорошая заглушка для рек.сервиса:
- если лежит рекомендатор, то показывается редакторская подборка
- если не работает ML поиск похожих, то подключается поиск похожих по жанрам и тегам

Дальнейшие шаги: 
- переиспользование топов
- перевзвешивание рекомендаций
- переранжирование персональным рекомендатром топ 1000 из разных категорий (вам понравится в новых, самое популярное для вас)

# Сложно не всегда хорошо
Топовая статья recsys 2019 разгром SOTA решений бейзлайнами:
https://github.com/MaurizioFD/RecSys2019_DeepLearning_Evaluation

